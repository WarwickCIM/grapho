<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How Grapho works â€¢ grapho</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How Grapho works">
<meta property="og:description" content="grapho">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grapho</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/GraphoInternals.html">How Grapho works</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="GraphoInternals_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How Grapho works</h1>
            
      
      
      <div class="hidden name"><code>GraphoInternals.Rmd</code></div>

    </div>

    
    
<p>Grapho records your R session activity including the code you send to the console, warnings, errors and visualisations. Here we go through the internals of the package in order to help you better understand a) what data is being collected, b) the limitations of the package and c) perhaps consider how one might extend or incorporate the functionality of the package to meet your own needs.</p>
<p>For any questions, please do contact <a href="mailto:james.tripp@warwick.ac.uk">James Tripp</a>.</p>
<div id="onboarding" class="section level1">
<h1 class="hasAnchor">
<a href="#onboarding" class="anchor"></a>Onboarding</h1>
<p>When grapho is first started, the .onAttach function in zzz.R runs. The user is welcomed to grapho and prompted to run the grapho_info function for more information about the project. Then the internal load_past_state function is run.</p>
<p>Load_past_state tries to read in the previously saved grapho variables. The variables are saved in an RDS file located in the grapho config directory. The location of the config directory is returned by the R_user_dir function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html">R_user_dir</a></span><span class="op">(</span><span class="st">"grapho"</span>, <span class="st">"config"</span><span class="op">)</span></code></pre></div>
<p>The RDS file is loaded if it exists and the load_past_state function returns TRUE. Otherwise we create the grapho variables and save them in an RDS file. The grapho variables are in a list found in the global environment.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.GlobalEnv</span><span class="op">$</span><span class="va">.grapho</span></code></pre></div>
<p>Next, the generate_ids() function creates the user and session ids. Both ids are added to the .grapho list and are created using the first 40 characters of a sha512 hash. The user id is a hash of the home, lang and r_platform environment variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html">digest</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"HOME"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"LANG"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"R_PLATFORM"</span><span class="op">)</span><span class="op">)</span>,
  algo <span class="op">=</span> <span class="st">"sha512"</span>
<span class="op">)</span>,  <span class="fl">1</span>, <span class="fl">40</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "0cef41a64514714e63b991fa6de9d8906b866f70"</code></pre>
<p>The string sent to the hash cannot be derived from the hash itself. Furthermore, we take a subset of the hash, to be on the safe side.</p>
<p>The session ID is a hash of the date.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html">digest</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/date.html">date</a></span><span class="op">(</span><span class="op">)</span>, algo <span class="op">=</span> <span class="st">"sha512"</span>
<span class="op">)</span>, <span class="fl">1</span>, <span class="fl">40</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "135302d18611e2f6fabd1547d38991c34025a28e"</code></pre>
<p>.onAttach() then displays different messages depending on the success of loading the past RDS file. If there was an RDS file then the user is informed they can view their current config settings by running the show_config() function, otherwise the user is prompted to run the setup_grapho() function.</p>
<p>Finally, .onAttach() enables the code and error recording functions. The function expression_recorder is registered as a callback function which is run each time code is sent to to the R interpreter. In order to record errors we change options$error() to grapho::error_recorder.</p>
</div>
<div id="grapho-configuration" class="section level1">
<h1 class="hasAnchor">
<a href="#grapho-configuration" class="anchor"></a>Grapho configuration</h1>
<p>Running the setup_grapho() function lets you set the .grapho variables.</p>
<ul>
<li><p><strong>Grapho folder</strong> - a choose folder window is shown after running the function. In RStudio, we use the selectDirectory function from the RStudio API. Otherwise, the tk_choose.dir function is used. The directory chosen becomes the current Grapho folder. All files created by grapho, except the RDS file containing the grapho options, are placed in this folder. Older grapho locations are also stored.</p></li>
<li><p><strong>Plot filetype</strong> - a text interface presented using the menu function from the utils package will prompt you to choose the file format grapho should use for the visualisation files. The available formats are .png .jpeg and .svg.</p></li>
<li><p><strong>Recording</strong> - Finally, you will be asked if you want to start grapho recording. You can toggle grapho recording on and off via the toggle_grapho function.</p></li>
</ul>
<p>Grapho variables, such as the current and past grapho folders, the plot filetype, the current log files and the if grapho is recording are stored in an object names .grapho. The object, a list, is in the global environment.</p>
<p>You can view the raw list by typing .grapho into the console.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.grapho</span></code></pre></div>
<pre><code>## $grapho_state_file
## [1] "/Users/jamestripp/Library/Preferences/org.R-project.R/R/grapho/grapho_state.RDS"
## 
## $config
## $config$recording
## [1] TRUE
## 
## $config$grapho_archive
## $config$grapho_archive$current
## [1] "~/Desktop/grapho_archive"
## 
## $config$grapho_archive$past
## [1] "~/Desktop/grapho_archive"
## 
## 
## $config$grapho_log_file
## [1] "~/Desktop/grapho_archive/210909T135808-consolelog-0cef41a64514714e63b991fa6de9d8906b866f70-135302d18611e2f6fabd1547d38991c34025a28e.txt"
## 
## $config$image_format
## [1] "svg"
## 
## $config$grapho_random_log_file
## [1] "~/Desktop/grapho_archive/210909T135808-random_consolelog-0cef41a64514714e63b991fa6de9d8906b866f70-135302d18611e2f6fabd1547d38991c34025a28e.txt"
## 
## 
## $ids
## $ids$user_id
## [1] "0cef41a64514714e63b991fa6de9d8906b866f70"
## 
## $ids$session_id
## [1] "135302d18611e2f6fabd1547d38991c34025a28e"</code></pre>
<p>Or by using the pretty printing function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/show_config.html">show_config</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##   Setting                     
## 1 Grapho recording            
## 2 Grapho archive              
## 3 Past archives               
## 4 Plot file format            
## 5 User ID                     
## 6 Session ID                  
## 7 Log file location           
## 8 Randomised log file location
##   Value                                                                                                                                         
## 1 ENABLED                                                                                                                                       
## 2 ~/Desktop/grapho_archive                                                                                                                      
## 3 ~/Desktop/grapho_archive                                                                                                                      
## 4 svg                                                                                                                                           
## 5 0cef41a64514714e63b991fa6de9d8906b866f70                                                                                                      
## 6 135302d18611e2f6fabd1547d38991c34025a28e                                                                                                      
## 7 ~/Desktop/grapho_archive/210909T135808-consolelog-0cef41a64514714e63b991fa6de9d8906b866f70-135302d18611e2f6fabd1547d38991c34025a28e.txt       
## 8 ~/Desktop/grapho_archive/210909T135808-random_consolelog-0cef41a64514714e63b991fa6de9d8906b866f70-135302d18611e2f6fabd1547d38991c34025a28e.txt</code></pre>
</div>
<div id="recording-commands-and-errors" class="section level1">
<h1 class="hasAnchor">
<a href="#recording-commands-and-errors" class="anchor"></a>Recording commands and errors</h1>
<p>This section details how the functions which record your activity work. When you run a command the expression_recorder is run. If you encounter an error then the error recorder is run.</p>
<p>Grapho will only record your activity if Grapho recording is enabled. You can see the status of grapho by running.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/show_config.html">show_config</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##   Setting                     
## 1 Grapho recording            
## 2 Grapho archive              
## 3 Past archives               
## 4 Plot file format            
## 5 User ID                     
## 6 Session ID                  
## 7 Log file location           
## 8 Randomised log file location
##   Value                                                                                                                                         
## 1 ENABLED                                                                                                                                       
## 2 ~/Desktop/grapho_archive                                                                                                                      
## 3 ~/Desktop/grapho_archive                                                                                                                      
## 4 svg                                                                                                                                           
## 5 0cef41a64514714e63b991fa6de9d8906b866f70                                                                                                      
## 6 135302d18611e2f6fabd1547d38991c34025a28e                                                                                                      
## 7 ~/Desktop/grapho_archive/210909T135808-consolelog-0cef41a64514714e63b991fa6de9d8906b866f70-135302d18611e2f6fabd1547d38991c34025a28e.txt       
## 8 ~/Desktop/grapho_archive/210909T135808-random_consolelog-0cef41a64514714e63b991fa6de9d8906b866f70-135302d18611e2f6fabd1547d38991c34025a28e.txt</code></pre>
<p>You can switch recording on and off by running the toggle_grapho function. Toggle grapho changes the variable .grapho<span class="math inline">\(config\)</span>recording to TRUE or FALSE, notifying you of the current state.</p>
<div id="expression_recorder" class="section level2">
<h2 class="hasAnchor">
<a href="#expression_recorder" class="anchor"></a>Expression_recorder</h2>
<p>The expression recorder has three jobs:</p>
<ul>
<li>Write warnings to the log file</li>
<li>Write commands to the log file</li>
<li>Save any new plot in the current device to the grapho archive folder</li>
</ul>
<div id="writing-warnings-and-commands" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-warnings-and-commands" class="anchor"></a>Writing warnings and commands</h3>
<p>These three actions depend on the existence of a grapho archive. If there is no archive then the user is prompted to run setup_grapho in order to create a grapho archive and the function exits.</p>
<p>If there is a grapho archive location set then the function goes about recording command and warnings. Commands are extracted by deparsing the top level expression passed to the function as part of the callback. Then the last warning is extracted using the last.warning variable. Both the warning and command are written out to the log file in the following format.</p>
<pre><code>##------ Day Month Numerical day hour:minute:second year ------##
COMMAND 
the deparsed command</code></pre>
<p>or</p>
<pre><code>##------ Day Month Numerical day hour:minute:second year ------##
WARNING 
the warning message</code></pre>
</div>
<div id="writing-out-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-out-plots" class="anchor"></a>Writing out plots</h3>
<p>Grapho only writes out new plots in your current device. The most recent plot is stored in the .grapho_plot variable in the global environment. After each command the current plot in the device is compared to the most recent and if the plots are different then a plot file is written and the current plot is stored in .grapho_plot.</p>
<p>We use the excellent grDevices::recordPlot() function to record plots. Plots are written out via an internal function called write_plot. We use the RStudio API, if available, or dev.copy.</p>
<p>The created file has the same height and width as the active device, with a file format as chosen via the setup_grapho function and with a filename generated by the internal create_filename function. The create filename function generated filenames consisting of the systemtime, filetype and then the session and user id.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">create_filename</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filetype</span><span class="op">)</span> <span class="op">{</span>

  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%y%d%mT%H%M%S"</span><span class="op">)</span>, <span class="st">"-"</span>,
    <span class="va">filetype</span>, <span class="st">"-"</span>,
    <span class="va">.GlobalEnv</span><span class="op">$</span><span class="va">.grapho</span><span class="op">$</span><span class="va">ids</span><span class="op">$</span><span class="va">user_id</span>, <span class="st">"-"</span>,
    <span class="va">.GlobalEnv</span><span class="op">$</span><span class="va">.grapho</span><span class="op">$</span><span class="va">ids</span><span class="op">$</span><span class="va">session_id</span>
  <span class="op">)</span>

<span class="op">}</span>

<span class="fu">create_filename</span><span class="op">(</span><span class="st">"current_plot"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "210909T135808-current_plot-0cef41a64514714e63b991fa6de9d8906b866f70-135302d18611e2f6fabd1547d38991c34025a28e"</code></pre>
</div>
</div>
</div>
<div id="viewing-and-parsing-your-archive" class="section level1">
<h1 class="hasAnchor">
<a href="#viewing-and-parsing-your-archive" class="anchor"></a>Viewing and parsing your archive</h1>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Tripp, Gregory McInerny.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
